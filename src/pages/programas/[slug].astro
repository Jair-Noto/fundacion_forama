---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/shared/Navbar.jsx';
import sql from '../../lib/db.js';
import { ArrowLeft, Calendar, MapPin, Activity } from 'lucide-react';

// --- 1. CONFIGURACI√ìN VISUAL ---
// FIX 1: Agregamos ': any' para que TypeScript no se queje por los √≠ndices num√©ricos
const estilosProgramas: any = {
  1: { color: "bg-green-600", image: "/imags/material_programas/proyect_1.jpg" },
  2: { color: "bg-blue-600", image: "/imags/material_programas/proyect_2.jpg" },
  3: { color: "bg-indigo-600", image: "/imags/material_programas/proyect_3.jpg" },
  4: { color: "bg-amber-600", image: "/imags/material_programas/proyect_4.jpg" },
  5: { color: "bg-rose-600", image: "/imags/material_programas/proyect_5.jpg" },
  6: { color: "bg-cyan-600", image: "/imags/material_programas/proyect_6.jpg" },
  7: { color: "bg-slate-600", image: "/imags/material_programas/proyect_7.jpg" },
  8: { color: "bg-purple-600", image: "/imags/material_programas/proyect_8.jpg" },
  9: { color: "bg-emerald-600", image: "/imags/material_programas/proyect_9.jpg" }
};

// --- 2. GENERAR RUTAS EST√ÅTICAS ---
export async function getStaticPaths() {
  const programas = await sql`SELECT slug FROM programas`;
  return programas.map((prog: any) => ({
    params: { slug: prog.slug },
  }));
}

// --- 3. OBTENER DATOS ---
const { slug } = Astro.params;

// Traemos el programa
console.log("üîç Intentando buscar programa con slug:", slug);
const result = await sql`SELECT * FROM programas WHERE slug = ${slug}`;
const programa = result[0];

console.log("‚úÖ RESULTADO DE LA BASE DE DATOS:", programa);

// üõë GUARDIA DE SEGURIDAD: (Importante para evitar errores de "undefined")
if (!programa) {
  return Astro.redirect('/404');
}

// Traemos sus proyectos
const proyectos = await sql`
  SELECT * FROM proyectos 
  WHERE programa_id = ${programa.id}
  ORDER BY fecha_publicacion DESC
`;

// Combinar estilos
// Al haber puesto ': any' arriba, esta l√≠nea ya no dar√° error rojo
const estilo = estilosProgramas[programa.id] || { color: "bg-gray-800", image: "" };

// FIX 2: Agregamos ': any' al par√°metro fecha
const formatearFecha = (fecha: any) => {
  if (!fecha) return '';
  // Convertimos expl√≠citamente a string o fecha para evitar errores
  return new Date(fecha).toLocaleDateString('es-BO', { year: 'numeric', month: 'long', day: 'numeric' });
};
---

<Layout title={programa.titulo}>
  <Navbar client:load />

  <main class="bg-stone-50 min-h-screen pb-20">
    
    <div class="relative bg-gray-900 pt-32 pb-24 overflow-hidden">
      <div class="absolute inset-0 opacity-40">
        <img src={estilo.image} class="w-full h-full object-cover" alt="" />
      </div>
      <div class={`absolute inset-0 ${estilo.color} mix-blend-multiply opacity-80`}></div>
      
      <div class="container relative z-10 mx-auto px-6 max-w-6xl">
        <a href="/programas" class="inline-flex items-center gap-2 text-white/80 hover:text-white transition-colors mb-6 font-medium backdrop-blur-sm bg-white/10 px-4 py-2 rounded-full w-fit">
          <ArrowLeft size={18} /> Volver a Programas
        </a>
        <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-6 leading-tight drop-shadow-lg">
          {programa.titulo}
        </h1>
        <p class="text-xl text-gray-100 max-w-2xl font-light leading-relaxed">
          {programa.descripcion}
        </p>
      </div>
    </div>

    <div class="container mx-auto px-6 max-w-5xl -mt-12 relative z-20">
      
      <div class="flex items-center gap-3 mb-8">
        <h2 class="text-2xl font-bold text-gray-800">Proyectos en curso</h2>
        <span class="bg-gray-200 text-gray-700 text-xs font-bold px-2 py-1 rounded-md">{proyectos.length}</span>
      </div>

      {proyectos.length === 0 ? (
        <div class="bg-white p-12 rounded-3xl shadow-sm text-center border border-gray-100">
          <div class="inline-flex p-4 rounded-full bg-gray-50 mb-4 text-gray-400">
            <Activity size={32} />
          </div>
          <h3 class="text-lg font-medium text-gray-900">Sin proyectos activos</h3>
          <p class="text-gray-500">Actualmente no hay proyectos p√∫blicos en esta categor√≠a.</p>
        </div>
      ) : (
        <div class="grid gap-6">
          {proyectos.map((proyecto: any) => (
            <article class="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 hover:shadow-xl transition-all duration-300 group">
              <div class="flex flex-col md:flex-row gap-6 justify-between items-start">
                
                <div class="space-y-4 flex-1">
                  <div class="flex flex-wrap items-center gap-3">
                    <span class={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide border 
                      ${proyecto.estado === 'En Ejecuci√≥n' ? 'bg-green-50 text-green-700 border-green-100' : 'bg-gray-50 text-gray-600 border-gray-100'}`}>
                      {proyecto.estado}
                    </span>
                    {proyecto.rubro && (
                       <span class="text-gray-500 text-xs font-medium bg-gray-50 px-2 py-1 rounded border border-gray-100">
                         {proyecto.rubro}
                       </span>
                    )}
                  </div>

                  <div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2 group-hover:text-amazon-800 transition-colors">
                      {proyecto.nombre}
                    </h3>
                    {proyecto.descripcion && (
                      <p class="text-gray-600 leading-relaxed">{proyecto.descripcion}</p>
                    )}
                  </div>
                  
                  <div class="flex items-center gap-6 pt-2 text-sm text-gray-400 font-medium">
                    {proyecto.ubicacion && (
                      <span class="flex items-center gap-1.5">
                        <MapPin size={16} className="text-gray-400" /> {proyecto.ubicacion}
                      </span>
                    )}
                    <span class="flex items-center gap-1.5">
                      <Calendar size={16} /> {formatearFecha(proyecto.fecha_publicacion)}
                    </span>
                  </div>
                </div>

              </div>
            </article>
          ))}
        </div>
      )}
    </div>
  </main>
</Layout>