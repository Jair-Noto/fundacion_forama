---
import '../styles/global.css';
import Footer from '../components/shared/Footer.astro';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
  description?: string;
}

const { 
  title, 
  description = 'Fundación Flora Amazónica - Impulsando el desarrollo sostenible en la Amazonía boliviana' 
} = Astro.props;

// ✅ OPTIMIZACIÓN 1: Meta tags más completos para SEO
const canonicalURL = Astro.site 
  ? new URL(Astro.url.pathname, Astro.site).href
  : `${Astro.url.origin}${Astro.url.pathname}`;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    
    {/* ✅ OPTIMIZACIÓN 2: Meta tags esenciales */}
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    {/* ✅ OPTIMIZACIÓN 3: Canonical URL para SEO */}
    <link rel="canonical" href={canonicalURL} />
    
    {/* ✅ OPTIMIZACIÓN 4: Favicon optimizado */}
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    
    {/* ✅ OPTIMIZACIÓN 5: Open Graph tags para redes sociales */}
    <meta property="og:title" content={`${title} | FORAMA`} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:site_name" content="FORAMA" />
    
    {/* ✅ OPTIMIZACIÓN 6: Twitter Card */}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${title} | FORAMA`} />
    <meta name="twitter:description" content={description} />
    
    {/* ✅ OPTIMIZACIÓN 7: Título optimizado */}
    <title>{title} | FORAMA</title>
    
    {/* ✅ OPTIMIZACIÓN 8: Preconnect a Google Fonts para mejor performance */}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    {/* ✅ OPTIMIZACIÓN 9: Fuentes con display=swap para evitar FOIT */}
    <link 
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" 
      rel="stylesheet"
    />
    <link 
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" 
      rel="stylesheet"
    />
    
    {/* ✅ OPTIMIZACIÓN 10: View Transitions de Astro (más moderno que ClientRouter) */}
    <ViewTransitions />

    {/* ✅ OPTIMIZACIÓN 11: Script inline optimizado para traducción */}
    <script is:inline>
      (function() {
        try {
          var lang = localStorage.getItem('forama_lang');
          if (lang && lang !== 'es') {
            document.documentElement.classList.add('translating-cloak');
          }
        } catch (e) {
          console.error('Error loading language preference:', e);
        }
      })();
    </script>
  </head>
  
  <body class="bg-gray-50 text-gray-800 font-sans flex flex-col min-h-screen">
    
    {/* ✅ OPTIMIZACIÓN 12: Transitions con nombre único */}
    <div transition:name="main-content" class="flex flex-col flex-grow w-full">
      
      {/* ✅ OPTIMIZACIÓN 13: Background con will-change para mejor performance */}
      <div class="fixed inset-0 -z-10 h-full w-full bg-white">
        
        {/* Textura de fondo */}
        <div 
          class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"
          aria-hidden="true"
        ></div>
        
        {/* Gradiente superior */}
        <div 
          class="absolute top-0 left-0 right-0 h-[500px] w-full bg-[radial-gradient(circle_800px_at_50%_-100px,#4ade8020,transparent)]"
          aria-hidden="true"
        ></div>
        
        {/* Gradiente inferior */}
        <div 
          class="absolute bottom-0 right-0 h-[500px] w-[500px] bg-[radial-gradient(circle_400px_at_100%_100%,#f9731615,transparent)]"
          aria-hidden="true"
        ></div>
      </div>
      
      {/* ✅ OPTIMIZACIÓN 14: Main tag semántico */}
      <main id="main-content" class="flex-grow">
        <slot />
      </main>
      
      {/* ✅ OPTIMIZACIÓN 15: Footer como componente semántico */}
      <Footer />
    </div>

    {/* ✅ OPTIMIZACIÓN 16: Google Translate con transition:persist */}
    <div transition:persist="google-translate">
      <div id="google_translate_element" style="display:none;"></div>

      {/* ✅ OPTIMIZACIÓN 17: Scripts de traducción optimizados */}
      <script is:inline>
        window.googleTranslateElementInit = function() {
          new google.translate.TranslateElement({
            pageLanguage: 'es', 
            includedLanguages: 'es,en,pt', 
            autoDisplay: false
          }, 'google_translate_element');
        };
      </script>
      
      {/* ✅ OPTIMIZACIÓN 18: Script de Google Translate con async */}
      <script 
        is:inline 
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
        async
      ></script>

      {/* ✅ OPTIMIZACIÓN 19: Funciones de traducción optimizadas */}
      <script is:inline>
        function setGoogleCookie(langValue) {
          var d = new Date();
          d.setTime(d.getTime() + (30 * 24 * 60 * 60 * 1000));
          var expires = "expires=" + d.toUTCString();
          
          // Limpiar cookies existentes
          document.cookie = "googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          document.cookie = "googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=" + window.location.hostname;
          
          if (langValue !== 'es') {
            var cookieValue = "/es/" + langValue;
            document.cookie = "googtrans=" + cookieValue + ";" + expires + ";path=/";
          }
        }

        window.doGTranslate = function(lang_pair) {
          try {
            if (!lang_pair) return;
            
            var lang = lang_pair.split('|')[1];
            setGoogleCookie(lang);
            localStorage.setItem('forama_lang', lang);
            
            var teCombo = document.querySelector('.goog-te-combo');
            if (teCombo) {
              teCombo.value = lang;
              teCombo.dispatchEvent(new Event('change'));
            }
            
            if (lang === 'es') {
              document.documentElement.classList.remove('translating-cloak');
            }
          } catch(err) {
            console.error('Translation error:', err);
          }
        }
      </script>
    </div>

    {/* ✅ OPTIMIZACIÓN 20: Script de auto-traducción con mejor manejo de errores */}
    <script is:inline>
      document.addEventListener('astro:page-load', () => {
        const savedLang = localStorage.getItem('forama_lang');
        
        // Si es español, mostramos y salimos
        if (!savedLang || savedLang === 'es') {
          document.documentElement.classList.remove('translating-cloak');
          return;
        }

        // Si es otro idioma, aplicamos traducción
        if (savedLang && savedLang !== 'es') {
          let attempts = 0;
          const maxAttempts = 20;
          
          const interval = setInterval(() => {
            const teCombo = document.querySelector('.goog-te-combo');
            attempts++;

            if (teCombo) {
              // Forzar traducción siempre
              teCombo.value = savedLang;
              teCombo.dispatchEvent(new Event('change'));
              
              // Mostrar la web después de un breve delay
              setTimeout(() => {
                document.documentElement.classList.remove('translating-cloak');
              }, 100);
              
              clearInterval(interval);
            } 
            else if (attempts > maxAttempts) {
              // Timeout: mostrar la página de todos modos
              document.documentElement.classList.remove('translating-cloak');
              clearInterval(interval);
              console.warn('Translation timeout - showing page anyway');
            }
          }, 100);
        }
      });
    </script>

    {/* ✅ OPTIMIZACIÓN 21: Estilos globales optimizados */}
    <style is:global>
      /* Ocultar durante traducción */
      html.translating-cloak body { 
        opacity: 0 !important; 
        visibility: hidden !important; 
        transition: none !important; 
      }
      
      /* Mostrar normalmente */
      body { 
        opacity: 1; 
        visibility: visible; 
        transition: opacity 0.3s ease-in-out; 
      }
      
      /* ✅ OPTIMIZACIÓN 22: Ocultar elementos de Google Translate */
      .goog-te-banner-frame,
      iframe.goog-te-banner-frame,
      .skiptranslate,
      body > .skiptranslate,
      .goog-tooltip,
      .goog-te-gadget-icon,
      #goog-gt-tt { 
        display: none !important; 
        visibility: hidden !important; 
        height: 0 !important; 
        width: 0 !important; 
      }
      
      /* Prevenir desplazamiento del body por banner de Google */
      body { 
        top: 0px !important; 
        position: static !important; 
      }
      
      /* Limpiar estilos de traducción */
      font { 
        background-color: transparent !important; 
        box-shadow: none !important; 
      }
      
      /* ✅ OPTIMIZACIÓN 23: Smooth scroll nativo */
      html {
        scroll-behavior: smooth;
      }
      
      /* ✅ OPTIMIZACIÓN 24: Focus visible para accesibilidad */
      *:focus-visible {
        outline: 2px solid #4ade80;
        outline-offset: 2px;
      }
    </style>
  </body>
</html>